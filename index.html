<link rel="apple-touch-icon" href="icon.png">
<meta name="theme-color" content="#0076BC">
<meta name="apple-mobile-web-app-title" content="Check dein Fahrzeug">
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fahrzeugkontrolle – Schwerlast (GitHub Pages)</title>
<meta name="color-scheme" content="light">
<!-- Eingebettetes App-Icon (Data-URL) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' ry='24' fill='%230076BC'/%3E%3Crect x='20' y='20' width='88' height='88' rx='18' ry='18' fill='none' stroke='white' stroke-width='6'/%3E%3Cpath d='M36 66 L58 86 L94 42' fill='none' stroke='white' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
<style>
  :root{--b:#e2e8f0;--mut:#64748b;--ok:#059669;--warn:#d97706;--bad:#dc2626}
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f8fafc;color:#0f172a}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);z-index:5}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{margin:0;font-size:20px} h2{margin:0 0 10px;font-size:18px}
  section{background:#fff;border:1px solid var(--b);border-radius:12px;padding:14px;margin:12px 0}
  .grid{display:grid;gap:10px}
  @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
  label span{font-size:14px;font-weight:600}
  input,textarea{width:100%;padding:12px;border:1px solid var(--b);border-radius:10px;font:inherit}
  textarea{min-height:56px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{background:#f1f5f9}
  .btn.ok.active{background:var(--ok);color:#fff}
  .btn.warn.active{background:var(--warn);color:#fff}
  .btn.bad.active{background:var(--bad);color:#fff}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--b);background:#eef2ff}
  .card{border:1px solid var(--b);border-radius:10px;padding:10px}
  .status{font-size:14px;color:#64748b}
  .photos{display:flex;gap:8px;overflow:auto}
  .ph{position:relative;width:92px;height:92px;border:1px solid var(--b);border-radius:8px;overflow:hidden;background:#f8fafc}
  .ph img{width:100%;height:100%;object-fit:cover}
  .x{position:absolute;right:4px;top:4px;width:22px;height:22px;border-radius:11px;border:1px solid var(--b);background:#fff;cursor:pointer;line-height:20px;text-align:center;font-size:14px}
  footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--b)}
  .help{font-size:12px;color:#475569}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>Fahrzeugkontrolle – Schwerlast/Zugmaschine</h1>
    <div class="row">
      <button class="btn" id="btnGeo">GPS-Ort</button>
      <button class="btn" id="btnPdf">PDF speichern</button>
      <button class="btn" id="btnMail">An Dispo (E-Mail + PDF)</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section>
    <h2>Empfänger / Versand</h2>
    <div class="grid grid-2">
      <label><span>Dispo-E-Mail *</span><input id="inDispo" placeholder="dispo@firma.de"></label>
      <label><span>CC (optional)</span><input id="inCc" placeholder="du@firma.de"></label>
    </div>
    <p class="help">PDF wird per Google-Relay verschickt (anhängend). Die E-Mail-Adressen werden nur lokal gespeichert.</p>
  </section>

  <section>
    <h2>Fahrzeugdaten</h2>
    <div class="grid grid-2">
      <label><span>Datum/Uhrzeit</span><input id="inDate" type="datetime-local"></label>
      <label><span>Fahrer/in *</span><input id="inOp" placeholder="Vorname Nachname"></label>
      <label><span>Zugmaschine *</span><input id="inTr" placeholder="DN-AB 1234"></label>
      <label><span>Auflieger/Modul *</span><input id="inTl" placeholder="…"></label>
      <label class="grid-col-span-2"><span>Ort</span><input id="inLoc" placeholder="automatisch per GPS oder manuell"></label>
    </div>
    <div class="status" id="geoOut" style="margin-top:6px"></div>
  </section>

  <section>
    <h2>Logo für Bericht (optional)</h2>
    <div class="row">
      <input type="file" id="inLogo" accept="image/*">
      <span class="help">Einmal auswählen → wird klein gespeichert (PDF bleibt &lt; 200 kB).</span>
    </div>
    <div id="logoInfo" class="status"></div>
  </section>

  <section>
    <h2>Checkliste (mit Fotos)</h2>
    <div id="checklist"></div>
    <p class="status">Fotos werden stark komprimiert.</p>
  </section>

  <section>
    <h2>Unterschrift</h2>
    <div class="card" style="overflow:hidden">
      <canvas id="sig" style="touch-action:none;width:100%;height:170px;"></canvas>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnClearSig">Löschen</button>
      <button class="btn" id="btnSaveSig">Übernehmen</button>
      <span id="sigStatus" class="status" style="display:none;color:#047857">Gespeichert ✓</span>
    </div>
  </section>
</main>

<footer><div class="wrap"><div id="status" class="status">Bereit</div></div></footer>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(function(){
  // >>>> HIER IST DEIN RELAY (funktioniert bereits) <<<<
  const RELAY_URL = 'https://script.google.com/macros/s/AKfycbzwp8iP9FUlFnddcz_ORZTXfqkeTnhz_k3kJxMU2AGZzXGSLylEe_g4uczH6FT-SxzPUg/exec';

  const { jsPDF } = window.jspdf;
  const $ = s => document.querySelector(s);
  const SKEY='fahrzeugkontrolle_pages_single';
  let state = JSON.parse(localStorage.getItem(SKEY) || '{}');
  state.res=state.res||{}; state.geo=state.geo||null; state.logo=state.logo||null; state.logoAspect=state.logoAspect||1;

  const items = [
    {id:'h1', sec:'Hydraulik & Schläuche', title:'Hydraulik-Kupplungen verriegelt & dicht', req:1},
    {id:'h2', sec:'Hydraulik & Schläuche', title:'Schläuche ohne Scheuer-/Knickstellen', req:1},
    {id:'h3', sec:'Hydraulik & Schläuche', title:'Druck-/Funktionsprobe ohne Auffälligkeiten', req:1},
    {id:'l1', sec:'Leckagen / Austritte',  title:'Kein Ölfilm an Verbindern/Flanschen', req:1},
    {id:'l2', sec:'Leckagen / Austritte',  title:'Keine Tropfenbildung / keine Pfützen', req:1},
    {id:'f1', sec:'Fahrzeug allgemein',    title:'Beleuchtung komplett i. O.', req:1},
    {id:'f2', sec:'Fahrzeug allgemein',    title:'Reifen/Felgen i. O.', req:1},
    {id:'f3', sec:'Fahrzeug allgemein',    title:'Bremsprobe bestanden', req:1},
    {id:'f4', sec:'Fahrzeug allgemein',    title:'Ladungssicherung plausibel', req:1},
    {id:'m1', sec:'Umweltschutz',          title:'Mobile Auffangmatten vorhanden & einsatzbereit', req:1}
  ];

  // Init
  window.addEventListener('DOMContentLoaded', ()=>{
    ['inDispo','inCc','inOp','inTr','inTl','inLoc'].forEach(id=>{ if(state[id]) $('#'+id).value=state[id]; });
    $('#inDate').value = localDateTimeValue();
    ['inDispo','inCc','inOp','inTr','inTl','inLoc','inDate'].forEach(id=>$('#'+id).addEventListener('input', persist));
    if(state.logo) $('#logoInfo').textContent='Logo gespeichert';
    renderChecklist(); initSignature();
    $('#btnGeo').onclick=onGeo; $('#btnPdf').onclick=onPdf; $('#btnMail').onclick=onMail; $('#inLogo').onchange=onLogoPick;
  });

  function persist(){ ['inDispo','inCc','inOp','inTr','inTl','inLoc','inDate'].forEach(id=>state[id]=$('#'+id).value); localStorage.setItem(SKEY, JSON.stringify(state)); }
  function setStatus(t){ $('#status').textContent=t; }
  function localDateTimeValue(d=new Date()){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`; }
  const safeText=v=> (v===undefined||v===null) ? '' : String(v);

  async function onGeo(){
    if(!navigator.geolocation){ alert('Kein GPS verfügbar.'); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      state.geo={lat:+pos.coords.latitude.toFixed(6), lon:+pos.coords.longitude.toFixed(6), acc:Math.round(pos.coords.accuracy)};
      $('#geoOut').textContent=`${state.geo.lat}, ${state.geo.lon} (±${state.geo.acc} m)`;
      try{
        const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.geo.lat}&lon=${state.geo.lon}&zoom=10&addressdetails=1`;
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        const d=await r.json(); const a=d.address||{};
        const place=a.city||a.town||a.village||a.municipality||a.county||'';
        if(place) { $('#inLoc').value=place; persist(); }
      }catch(_){}
    }, err=> alert('GPS fehlgeschlagen: '+(err?.message||err)));
  }

  async function onLogoPick(e){
    const f=e.target.files && e.target.files[0]; if(!f) return;
    const data = await compressImageFile(f, 320, 0.8);
    const info = await probeImage(data);
    state.logo=data; state.logoAspect=info.w/info.h||1; $('#logoInfo').textContent=`Logo gespeichert (${info.w}×${info.h})`; persist();
  }
  function probeImage(dataUrl){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res({w:i.width,h:i.height}); i.src=dataUrl; }); }

  function renderChecklist(){
    const host=$('#checklist'); host.innerHTML='';
    const groups=[...new Set(items.map(i=>i.sec))];
    groups.forEach(sec=>{
      host.insertAdjacentHTML('beforeend', `<div style="font-weight:700;margin:6px 0">${sec}</div>`);
      items.filter(i=>i.sec===sec).forEach(it=>{
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:8px"><div style="font-weight:600">${it.title}</div>${it.req?'<span class="chip">Pflicht</span>':''}</div>
            <div class="row"><button class="btn" data-sev="OK">OK</button><button class="btn" data-sev="Hinweis">Hinweis</button><button class="btn" data-sev="Mangel">Mangel</button></div>
          </div>
          <textarea placeholder="Bemerkung / Maßnahmen…"></textarea>
          <label style="display:block;margin-top:6px"><span style="font-size:14px;font-weight:600">Foto hinzufügen</span>
            <input type="file" accept="image/*" capture="environment" style="display:block;margin-top:6px"></label>
          <div class="photos" id="ph_${it.id}"></div>
        `;
        host.appendChild(card);
        if(!state.res[it.id]) state.res[it.id]={sev:'',note:'',photos:[]};

        const btns=card.querySelectorAll('button[data-sev]');
        const mark=v=>{ btns.forEach(b=>b.className='btn'); btns.forEach(b=>{ if(b.dataset.sev===v){ b.className+=' '+(v==='OK'?'ok':v==='Hinweis'?'warn':'bad')+' active'; } }); };
        if(state.res[it.id].sev) mark(state.res[it.id].sev);
        btns.forEach(b=> b.onclick=()=>{ state.res[it.id].sev=b.dataset.sev; mark(b.dataset.sev); persist(); });

        const ta=card.querySelector('textarea'); ta.value=state.res[it.id].note||''; ta.oninput=()=>{ state.res[it.id].note=ta.value; persist(); };

        const fi=card.querySelector('input[type=file]'); fi.onchange=async e=>{
          const f=e.target.files && e.target.files[0]; if(!f) return;
          const url=await compressImageFile(f, 700, 0.42);
          state.res[it.id].photos.push(url); redrawPhotos(it.id); persist(); fi.value='';
        };
        redrawPhotos(it.id);
      });
    });
  }
  function redrawPhotos(id){
    const bar=$('#ph_'+id); if(!bar) return; bar.innerHTML='';
    (state.res[id].photos||[]).forEach((p,idx)=>{
      const d=document.createElement('div'); d.className='ph';
      d.innerHTML=`<img src="${p}"><button class="x" title="Entfernen">×</button>`;
      d.querySelector('.x').onclick=()=>{ state.res[id].photos.splice(idx,1); persist(); redrawPhotos(id); };
      bar.appendChild(d);
    });
  }

  function compressImageFile(file,maxDim=700,quality=0.42){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>{ const img=new Image(); img.onload=()=>{
        const c=document.createElement('canvas'); let w=img.width,h=img.height; const s=Math.min(1,maxDim/Math.max(w,h));
        w=Math.round(w*s); h=Math.round(h*s); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      }; img.src=r.result; };
      r.onerror=reject; r.readAsDataURL(file);
    });
  }

  function initSignature(){
    const c=$('#sig'),ctx=c.getContext('2d');
    size(); window.addEventListener('resize',size);
    function size(){ const w=c.clientWidth,h=170,px=window.devicePixelRatio||1; c.style.width=w+'px'; c.style.height=h+'px'; c.width=Math.round(w*px); c.height=Math.round(h*px); ctx.setTransform(px,0,0,px,0,0); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#111827'; }
    let down=false,last=null; const P=e=>{const r=c.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}};
    c.addEventListener('pointerdown',e=>{down=true; last=P(e);}); c.addEventListener('pointerup',()=>{down=false; last=null;}); c.addEventListener('pointerleave',()=>{down=false; last=null;});
    c.addEventListener('pointermove',e=>{if(!down)return; const p=P(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p;});
    $('#btnClearSig').onclick=()=>{ctx.clearRect(0,0,c.width,c.height); state.sig=''; $('#sigStatus').style.display='none'; persist(); };
    $('#btnSaveSig').onclick=()=>{ state.sig=c.toDataURL('image/jpeg',0.8); $('#sigStatus').style.display='inline'; persist(); };
  }

  function buildPdf(){
    const doc=new jsPDF({unit:'pt',format:'a4'}); const m=40; let y=m; const lh=16;
    const line=(t='',bold=false)=>{ doc.setFont('helvetica',bold?'bold':'normal'); doc.text(safeText(t), m, y); y+=lh; if(y>800){doc.addPage(); y=m;} };
    if(state.logo){ try{ const pageW=doc.internal.pageSize.getWidth(); const w=80, h=Math.round(w/(state.logoAspect||1)); const x=pageW-m-w; doc.addImage(state.logo,'JPEG',x,m-10,w,h); }catch(e){} }
    doc.setFontSize(14); line('Fahrzeugkontrolle – Schwerlast/Zugmaschine',true); doc.setFontSize(10);
    line('Datum/Uhrzeit: '+($('#inDate').value||'')); line('Fahrer/in: '+($('#inOp').value||'')); line('Zugmaschine: '+($('#inTr').value||'')); line('Auflieger/Modul: '+($('#inTl').value||'')); if($('#inLoc').value) line('Ort: '+($('#inLoc').value));
    if(state.geo) line('Geotag: '+(state.geo.lat+', '+state.geo.lon+' (±'+state.geo.acc+' m)')); line();
    const anyBad=Object.values(state.res).some(r=>r.sev==='Mangel'); line('Freigabe: '+(anyBad?'NICHT ERTEILT (Mangel vorhanden)':'ERTEILT')); line();
    line('Checkpunkte:',true); items.forEach(it=>{const r=state.res[it.id]||{}; line('- ['+(r.sev||'?')+'] '+it.title); if(r.note) line('   Notiz: '+r.note);});
    line(); line('Digitale Unterschrift:',true);
    if(state.sig){ try{ doc.addImage(state.sig,'JPEG',m,y,180,50); y+=60; }catch(e){ line('(keine Signatur einbettbar)'); } } else line('(keine Signatur)');
    items.forEach(it=>{
      const r=state.res[it.id]; if(!r||!r.photos||!r.photos.length)return;
      doc.addPage(); y=m; line('Fotos – '+it.title,true); y+=6;
      r.photos.forEach(p=>{ try{ const w=260,h=Math.round(w*0.62); if(y+h+lh>820){doc.addPage(); y=m;} doc.addImage(p,'JPEG',m,y,w,h); y+=h+8; }catch(_){ line('(Foto konnte nicht eingebettet werden)'); } });
    });
    return doc.output('blob');
  }

  function onPdf(){
    try{
      const blob=buildPdf();
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='Fahrzeugkontrolle.pdf'; a.click();
      URL.revokeObjectURL(url); setStatus('PDF gespeichert ('+(blob.size/1024/1024).toFixed(2)+' MB)');
    }catch(err){ alert('PDF-Fehler: '+err); }
  }

  const blobToBase64 = blob => new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(blob); });

async function onMail() {
  const problems = [];
  const $id = (x) => document.getElementById(x);

  // ---- Pflichtprüfungen
  if (!$id('inDispo')?.value) problems.push('Dispo-E-Mail fehlt');
  if (!$id('inOp')?.value || !$id('inTr')?.value || !$id('inTl')?.value)
    problems.push('Fahrer/in und beide Kennzeichen sind Pflicht');

  const notRated = items
    .filter(it => !(state.res[it.id] && state.res[it.id].sev))
    .map(it => it.title);
  if (notRated.length) problems.push('Nicht bewertet: ' + notRated.join(', '));

  if (problems.length) {
    alert('Versand blockiert:\n- ' + problems.join('\n- '));
    return;
  }

  // ---- Helfer: Werte robust lesen (Input → Text → LocalStorage)
  const fromLS = (k) => (localStorage.getItem(k) || '').trim();
  const val = (id, lsKey=null) => {
    const el = $id(id);
    const v = el ? (('value' in el ? el.value : el.textContent) || '').trim() : '';
    if (v) return v;
    if (lsKey) {
      const w = fromLS(lsKey);
      if (w) return w;
    }
    return '';
  };

  try {
    setStatus('Erzeuge PDF …');
    const pdfBlob  = buildPdf();
    const base64   = await blobToBase64(pdfBlob);
    const filename = `Fahrzeugkontrolle_${(val('inTr','tr')||'Zug')}_${(val('inTl','tl')||'Aufl')}.pdf`;

    // ---- Freigabe zuerst berechnen
    const anyBad = items.some(it => (state.res[it.id] && state.res[it.id].sev === 'Mangel'));
    const freigabeText = anyBad ? 'NICHT ERTEILT (Mangel vorhanden)' : 'ERTEILT';

    // ---- Kopfzeilen (robust lesen)
    const dt  = val('inDate', 'date');
    const op  = val('inOp',   'op');
    const tr  = val('inTr',   'tr');
    const tl  = val('inTl',   'tl');
    const loc = val('inLoc',  'loc');

    const lines = [];
    lines.push(`Datum/Uhrzeit: ${dt || '-'}`);
    lines.push(`Fahrer/in: ${op || '-'}`);
    lines.push(`Zugmaschine: ${tr || '-'} | Auflieger/Modul: ${tl || '-'}`);
    if (loc) lines.push(`Ort: ${loc}`);
    if (state.geo) lines.push(`Geotag: ${state.geo.lat}, ${state.geo.lon} (±${state.geo.acc} m)`);

    // ---- Checkliste kompakt
    const checkRows = items.map(it => {
      const r = state.res[it.id] || {};
      const sev = r.sev || '-';
      const note = (r.note && r.note.trim()) ? ` – ${r.note.trim()}` : '';
      return `• [${sev}] ${it.title}${note}`;
    }).join('\n');

    // ---- Text & HTML
    const subject = `Fahrzeugkontrolle ${tr || 'Zug'} / ${tl || 'Aufl'}`;

    const bodyText = `Fahrzeugkontrolle – Schwerlast/Zugmaschine
${lines.join('\n')}

Freigabe: ${freigabeText}

Checkpunkte:
${checkRows}

(Details siehe PDF-Anhang)`;

    const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const bodyHtml =
      `<div style="font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:14px;line-height:1.5">
         <h2 style="margin:0 0 8px 0">Fahrzeugkontrolle – Schwerlast/Zugmaschine</h2>
         <div>${lines.map(s => `<div>${esc(s)}</div>`).join('')}</div>
         <div style="margin:10px 0 0 0"><strong>Freigabe: ${esc(freigabeText)}</strong></div>
         <div style="margin:10px 0 4px 0"><strong>Checkpunkte:</strong></div>
         <ul style="margin:0;padding-left:18px">
           ${items.map(it => {
             const r = state.res[it.id] || {};
             const sev = r.sev || '-';
             const note = (r.note && r.note.trim()) ? ' – ' + esc(r.note.trim()) : '';
             return `<li>[${esc(sev)}] ${esc(it.title)}${note}</li>`;
           }).join('')}
         </ul>
         <div style="margin-top:10px">(Details siehe PDF-Anhang)</div>
       </div>`;

    // ---- Payload & Versand
    const payload = {
      to: $id('inDispo').value.trim(),
      cc: ($id('inCc')?.value || '').trim(),
      subject,
      text: bodyText,
      html: bodyHtml,
      filename,
      pdfBase64: base64
    };

    setStatus('Sende über Relay …');

    try {
      await fetch(RELAY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      await fetch(RELAY_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    }

    setStatus('Bericht gesendet ✓');
    alert('E-Mail mit PDF-Anhang wurde gesendet.');

  } catch (err) {
    setStatus('Senden fehlgeschlagen');
    alert('Fehler beim Versand: ' + (err?.message || err));
  }
}

})();
</script>
</body>
</html>
